variables:
  AWS_REGION: us-gov-west-1
  ECR_REGISTRY: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
  IMAGE_NAME: sre-assistant
  HELM_CHART_PATH: helm/sre-assistant

stages:
  - build
  - deploy

build:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $ECR_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $ECR_REGISTRY/$IMAGE_NAME:latest
    - docker push $ECR_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $ECR_REGISTRY/$IMAGE_NAME:latest
  only:
    - main
    - develop

deploy:dev:
  stage: deploy
  image: alpine/helm:3.13.0
  before_script:
    - apk add --no-cache aws-cli
    - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
  script:
    - |
      helm upgrade --install sre-assistant $HELM_CHART_PATH \
        --namespace sre-assistant \
        --create-namespace \
        --set image.repository=$ECR_REGISTRY/$IMAGE_NAME \
        --set image.tag=$CI_COMMIT_SHORT_SHA \
        --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=$POD_IDENTITY_ROLE_ARN \
        --set bedrock.agentId=$BEDROCK_AGENT_ID \
        --set bedrock.region=$AWS_REGION \
        --set secret.method=${SECRETS_METHOD:-native} \
        --set secret.secretKey=$FLASK_SECRET_KEY \
        --set secret.externalSecrets.secretName=${AWS_SECRET_NAME:-sre-assistant-flask-secret} \
        --set secret.csiDriver.secretName=arn:aws-us-gov:secretsmanager:$AWS_REGION:$AWS_ACCOUNT_ID:secret:${AWS_SECRET_NAME:-sre-assistant-flask-secret} \
        --set ingress.certificateArn=$ACM_CERTIFICATE_ARN \
        --set ingress.host=$INGRESS_HOST \
        --wait \
        --timeout 5m
  environment:
    name: development
    url: https://$INGRESS_HOST
  only:
    - develop

deploy:prod:
  stage: deploy
  image: alpine/helm:3.13.0
  before_script:
    - apk add --no-cache aws-cli
    - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
  script:
    - |
      helm upgrade --install sre-assistant $HELM_CHART_PATH \
        --namespace sre-assistant \
        --create-namespace \
        --set image.repository=$ECR_REGISTRY/$IMAGE_NAME \
        --set image.tag=$CI_COMMIT_SHORT_SHA \
        --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=$POD_IDENTITY_ROLE_ARN \
        --set bedrock.agentId=$BEDROCK_AGENT_ID \
        --set bedrock.region=$AWS_REGION \
        --set secret.method=${SECRETS_METHOD:-native} \
        --set secret.secretKey=$FLASK_SECRET_KEY \
        --set secret.externalSecrets.secretName=${AWS_SECRET_NAME:-sre-assistant-flask-secret} \
        --set secret.csiDriver.secretName=arn:aws-us-gov:secretsmanager:$AWS_REGION:$AWS_ACCOUNT_ID:secret:${AWS_SECRET_NAME:-sre-assistant-flask-secret} \
        --set ingress.certificateArn=$ACM_CERTIFICATE_ARN \
        --set ingress.host=$INGRESS_HOST \
        --set replicaCount=3 \
        --set autoscaling.enabled=true \
        --wait \
        --timeout 10m
  environment:
    name: production
    url: https://$INGRESS_HOST
  when: manual
  only:
    - main
